# Excel DSL 规范说明 (v1.3)

本规范定义了一套声明式 JSON 结构，用于描述 Excel 文件，实现对 `rust_xlsxwriter` 特性的全面映射。

## 1. 范围描述符规范 (Range Specification)

为了兼顾易读性与机器处理效率，规范中所有 `range` 或 `location` 属性均支持以下两种格式：

| **格式**    | **类型** | **说明**              | **示例**                                                                     |
| ----------------- | -------------- | --------------------------- | ---------------------------------------------------------------------------------- |
| **A1 引用** | `string`     | 使用 Excel 标准字符串表示法 | `"A1:C10"`或 `"B2"`                                                            |
| **坐标系**  | `object`     | 使用从 0 开始的数字索引     | 区域：`{"r1": 0, "c1": 0, "r2": 9, "c2": 2}` ``单格：`{"r": 1, "c": 1}` |

## 2. 顶层结构 (Root)

| **字段** | **类型** | **说明**                      | **示例**            |
| -------------- | -------------- | ----------------------------------- | ------------------------- |
| `filename`   | string         | 输出文件名                          | `"Analysis_v3.xlsx"`    |
| `properties` | object         | 文档元数据 (Title, Author, Company) | `{ "author": "Admin" }` |
| `styles`     | object         | 全局样式池                          | (见第 3 节)               |
| `sheets`     | array          | 工作表集合                          | (见第 4 节)               |

## 3. 样式细节 (Styles)

样式对象映射自 `rust_xlsxwriter::Format`。

| **模块**    | **属性**      | **类型** | **说明**     | **示例**             |
| ----------------- | ------------------- | -------------- | ------------------ | -------------------------- |
| **font**    | `bold`/`italic` | bool           | 加粗/倾斜          | `true`                   |
| ``         | `color`           | string         | 颜色 (Hex)         | `"#FF0000"`              |
| **fill**    | `color`           | string         | 背景色             | `"#FFFF00"`              |
| **align**   | `h`/`v`         | string         | 水平/垂直对齐      | `"center"`,`"vcenter"` |
| ``         | `text_wrap`       | bool           | 自动换行           | `true`                   |
| **border**  | `around`          | number         | 四周边框线型(1-13) | `1`(Thin)                |
| **protect** | `locked`          | bool           | 是否锁定单元格     | `true`                   |

## 4. 工作表与单元格 (Worksheet & Cells)

### 4.1 单元格定义 (Cells)

| **属性** | **类型** | **说明**                               | **示例** |
| -------------- | -------------- | -------------------------------------------- | -------------- |
| `r`/`c`    | number         | 行索引 / 列索引 (0-based)                    | `0`,`0`    |
| `type`       | string         | 数据类型 (string, number, datetime, formula) | `"number"`   |
| `value`      | any            | 单元格实际数据                               | `100.5`      |
| `style`      | string         | 引用样式 ID                                  | `"s_header"` |

### 4.2 工作表增强属性

| **属性**          | **类型** | **说明**                       | **示例**                                  |
| ----------------------- | -------------- | ------------------------------------ | ----------------------------------------------- |
| `merges`              | array          | 合并单元格集合 (支持 A1 或 坐标对象) | `["A1:B2", {"r1":5, "c1":0, "r2":5, "c2":3}]` |
| `data_validations`    | array          | 数据校验规则                         | (见 5.1)                                        |
| `conditional_formats` | array          | 条件格式规则                         | (见 5.2)                                        |
| `sparklines`          | array          | 迷你图配置                           | (见 5.3)                                        |

## 5. 高级特性范围应用示例

### 5.1 数据校验 (Data Validation)

| **字段**  | **类型**    | **说明** | **示例 (A1 vs 坐标)**                         |
| --------------- | ----------------- | -------------- | --------------------------------------------------- |
| **range** | `string/object` | 生效范围       | `"B1:B10"`或 `{"r1":0, "c1":1, "r2":9, "c2":1}` |
| `type`        | string            | 校验类型       | `"list"`                                          |
| `value`       | array/string      | 允许的值       | `["Yes", "No"]`                                   |

### 5.2 条件格式 (Conditional Formatting)

| **字段**  | **类型**    | **说明**      | **示例**                                        |
| --------------- | ----------------- | ------------------- | ----------------------------------------------------- |
| **range** | `string/object` | 作用范围            | `"C2:C100"`或 `{"r1":1, "c1":2, "r2":99, "c2":2}` |
| `type`        | string            | 条件类型            | `"data_bar"`                                        |
| `style`       | string            | 满足条件时的样式 ID | `"s_red_fill"`                                      |

### 5.3 迷你图 (Sparklines)

| **字段**     | **类型**    | **说明**       | **示例**                |
| ------------------ | ----------------- | -------------------- | ----------------------------- |
| **location** | `string/object` | 插入单元格位置       | `"E1"`或 `{"r":0, "c":4}` |
| **range**    | `string`        | 数据源(需带表名引用) | `"Sheet1!A1:D1"`            |

## 6. 综合示例 (A1 与 坐标系混用)

```
{
  "filename": "Hybrid_Range_Report.xlsx",
  "styles": {
    "s_bold": { "font": { "bold": true } }
  },
  "sheets": [
    {
      "name": "Sales",
      "merges": [
        "A1:E1",
        { "r1": 2, "c1": 0, "r2": 5, "c2": 0 }
      ],
      "cells": [
        { "r": 0, "c": 0, "type": "string", "value": "年度分析报表", "style": "s_bold" }
      ],
      "tables": [
        {
          "range": { "r1": 6, "c1": 0, "r2": 20, "c2": 4 },
          "style": "TableStyleMedium9",
          "columns": [{ "header": "日期" }, { "header": "金额" }]
        }
      ],
      "conditional_formats": [
        {
          "range": "B7:B20",
          "type": "cell",
          "criteria": ">",
          "value": 5000,
          "style": "s_bold"
        }
      ]
    }
  ]
}

```
